{% extends "layout/base.html" %}

{% block content %}
<div class="top-bar">
    <h1>Pipeline</h1>
    <button onclick="document.getElementById('dealModal').showModal()" class="btn btn-primary">+ New Deal</button>
</div>

<div class="pipeline-board">
    {% for stage in stages %}
    <div class="pipeline-column" ondrop="drop(event, '{{ stage }}')" ondragover="allowDrop(event)">
        <div class="column-header">
            <span>{{ stage.replace('_', ' ')|capitalize }}</span>
            <span class="count-badge">{{ deals_by_stage[stage]|length }}</span>
        </div>
        
        {% for deal in deals_by_stage[stage] %}
        <div class="deal-card" draggable="true" ondragstart="drag(event, '{{ deal.id }}')">
            <div style="font-weight: 600;">{{ deal.title }}</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">{{ deal.contact.name }}</div>
            <div class="deal-value">${{ "{:,.0f}".format(deal.value) }}</div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary);">
                <span>{{ deal.probability }}% prob.</span>
                <span>{{ deal.expected_close.strftime('%b %d') if deal.expected_close else '-' }}</span>
            </div>
            
            <div class="probability-bar">
                <div class="probability-fill" style="width: {{ deal.probability }}%; background-color: {% if deal.probability > 70 %}var(--success){% elif deal.probability > 40 %}var(--warning){% else %}var(--danger){% endif %};"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<!-- New Deal Modal -->
<dialog id="dealModal" style="border: none; border-radius: 8px; padding: 0; max-width: 500px; width: 100%;">
    <div style="padding: 1.5rem;">
        <h3 style="margin-top: 0;">New Deal</h3>
        <form action="/pipeline/deals" method="post">
            <div class="form-group">
                <label>Title</label>
                <input type="text" name="title" required>
            </div>
            <div class="form-group">
                <label>Contact ID</label>
                <!-- In a real app this would be a search/dropdown. For now just ID or maybe fetch contacts? -->
                <!-- Let's assume we can enter ID or we should have passed contacts to this template. -->
                <!-- I forgot to pass contacts to this template. I will update pipeline.py later if needed. -->
                <!-- But for now, let's just use input number as a fallback. -->
                <input type="number" name="contact_id" required placeholder="Enter Contact ID">
            </div>
            <div class="form-group">
                <label>Value ($)</label>
                <input type="number" step="0.01" name="value" required>
            </div>
            <div class="form-group">
                <label>Stage</label>
                <select name="stage">
                    {% for s in stages %}
                    <option value="{{ s }}">{{ s.replace('_', ' ')|capitalize }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Probability (%)</label>
                <input type="number" min="0" max="100" name="probability" value="50">
            </div>
            <div class="form-group">
                <label>Expected Close</label>
                <input type="date" name="expected_close">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button type="button" onclick="document.getElementById('dealModal').close()" class="btn btn-outline">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev, id) {
        ev.dataTransfer.setData("text", id);
    }

    function drop(ev, stage) {
        ev.preventDefault();
        var id = ev.dataTransfer.getData("text");
        
        // Optimistic UI update could be done here, but let's just reload or move element
        // Send POST request
        const formData = new FormData();
        formData.append('stage', stage);
        
        fetch(`/pipeline/deals/${id}/move`, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                window.location.reload(); // Simple reload to refresh state
            } else {
                alert('Failed to move deal');
            }
        });
    }
</script>
{% endblock %}
