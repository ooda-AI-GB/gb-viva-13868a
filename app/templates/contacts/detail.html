{% extends "layout/base.html" %}

{% block content %}
<div class="top-bar">
    <h1>{{ contact.name }}</h1>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/contacts/{{ contact.id }}/edit" class="btn btn-outline">Edit</a>
        <form action="/contacts/{{ contact.id }}/delete" method="post" onsubmit="return confirm('Are you sure?');" style="margin: 0;">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
    <!-- Main Info -->
    <div>
        <div class="card">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label>Email</label>
                    <div><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></div>
                </div>
                <div>
                    <label>Phone</label>
                    <div>{{ contact.phone or '-' }}</div>
                </div>
                <div>
                    <label>Company</label>
                    <div>{{ contact.company or '-' }}</div>
                </div>
                <div>
                    <label>Title</label>
                    <div>{{ contact.title or '-' }}</div>
                </div>
                <div>
                    <label>Status</label>
                    <div><span class="badge badge-{{ contact.status }}">{{ contact.status.replace('_', ' ') }}</span></div>
                </div>
                <div>
                    <label>Source</label>
                    <div>{{ contact.source or '-' }}</div>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <label>Notes</label>
                <div style="white-space: pre-wrap; color: var(--text-secondary);">{{ contact.notes or 'No notes.' }}</div>
            </div>
        </div>

        <!-- Deals -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Deals</h2>
                <!-- Link to create deal pre-filled? For now just list -->
            </div>
            {% if deals %}
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Value</th>
                            <th>Stage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for deal in deals %}
                        <tr>
                            <td>{{ deal.title }}</td>
                            <td>${{ "{:,.0f}".format(deal.value) }}</td>
                            <td><span class="badge badge-{{ deal.stage }}">{{ deal.stage.replace('_', ' ') }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div style="color: var(--text-secondary);">No deals found.</div>
            {% endif %}
        </div>

        <!-- Activity Timeline -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Activity Timeline</h2>
                <button onclick="document.getElementById('activityModal').showModal()" class="btn btn-sm btn-primary">+ Add Activity</button>
            </div>
            <div class="timeline">
                {% for activity in activities %}
                <div class="timeline-item">
                    <div class="timeline-marker"></div>
                    <div style="font-weight: 600;">{{ activity.type|capitalize }}: {{ activity.subject }}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.25rem;">{{ activity.description or '' }}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        {{ activity.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sidebar Actions -->
    <div>
        <div class="card">
            <h3>Actions</h3>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button onclick="requestIntel()" class="btn btn-outline" style="width: 100%;">âœ¨ Request Company Intel</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Activity Modal -->
<dialog id="activityModal" style="border: none; border-radius: 8px; padding: 0; max-width: 500px; width: 100%;">
    <div style="padding: 1.5rem;">
        <h3 style="margin-top: 0;">Add Activity</h3>
        <form action="/activities" method="post">
            <input type="hidden" name="contact_id" value="{{ contact.id }}">
            <div class="form-group">
                <label>Type</label>
                <select name="type" required>
                    <option value="call">Call</option>
                    <option value="email">Email</option>
                    <option value="meeting">Meeting</option>
                    <option value="note">Note</option>
                    <option value="task">Task</option>
                </select>
            </div>
            <div class="form-group">
                <label>Subject</label>
                <input type="text" name="subject" required>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="datetime-local" name="date_str" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="description" style="min-height: 100px;"></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button type="button" onclick="document.getElementById('activityModal').close()" class="btn btn-outline">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div>
</dialog>

<script>
    async function requestIntel() {
        const company = "{{ contact.company }}";
        if (!company) {
            alert("No company name associated with this contact.");
            return;
        }
        
        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "Analyzing...";
        btn.disabled = true;

        try {
            const response = await fetch('/api/intel/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    company_name: company,
                    analysis_type: 'swot'
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                window.location.href = `/intel/${data.id}`;
            } else {
                alert('Analysis failed: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            alert('Error requesting analysis');
            console.error(error);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
</script>
{% endblock %}
